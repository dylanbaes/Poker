<!doctype html>
<html>
<meta charset="utf-8">

<head>
  <title>Web Poker</title>
  <link rel="stylesheet" href="page_style.css">
</head>

<div id ="credentials"></div>

<body>
  <p>message: <input id="send_text" type="text">
    <input type="button" name="send_button" value="send" onclick="send()">
  </p>
  <div id="nameInput">
    <p>name: <input id="sendName" type="text">
      <input type="button" name="sendName" value="Name" onclick="sendName()">
    </p>
  </div>

  <div id="rounds">

  </div>

  <img id="card1" src="1J.svg" style="width:auto;">
  <img id="card2" src="1J.svg" style="width:auto;">
  <img id="card3" src="1J.svg" style="width:auto;">
  <img id="card4" src="1J.svg" style="width:auto;">
  <img id="card5" src="1J.svg" style="width:auto;">

  <div id="actionButtons">
    <button id="stand" onclick="stand(0)">Stand</button>
    <button id="bet" onclick="bet(0)">Bet</button>
    <button id="fold" onclick="fold(0)">Fold</button>
  </div>
  <div id="standPrompt" class="hidden">
    <button id="Confirm" onclick="stand(1)">Confirm</button>
    <button id="Cancel" onclick="stand(-1)">Cancel</button>
  </div>
  <div id="foldPrompt" class="hidden">
    <button id="Confirm" onclick="fold(1)">Confirm</button>
    <button id="Cancel" onclick="fold(-1)">Cancel</button>
  </div>
  <div id="slide" class="hidden">
    <span id="rangeValue">1</span>
    <input type="range" id="slider" min="1" max="100" value="0" class="slider" id="myRange" onchange="rangeSlide(this.value)" onmousemove="rangeSlide(this.value)">
    <button id="confirm" onclick="bet(slider.value)">Confirm</button>
    <button id="cancel" onclick="bet(-1)">Cancel</button>
  </div>

  <div id="textbox"></div>
  <div id="roundDisplay"></div>
</body>

</html>
<script>

  var connection = null;

  var serverUrl;
  serverUrl ="ws://" + window.location.hostname + ":8880";
  
  connection = new WebSocket(serverUrl);
  connection.onopen = function (evt) {
    console.log("open");
  }

  var cardIdx = 0;
  var playerID = 0;
  var cards = [];
  var name = "Player " + (playerID+1);
  var cardI = ["card1", "card2", "card3", "card4", "card5"];

  connection.onmessage = function (evt) {
    var msg;
    msg = evt.data;
    console.log("Message received: ");
    document.getElementById("textbox").innerText = document.getElementById("textbox").innerText + '\n\n' + "Message Received" + "\n" + msg;

    // This is a hack for this example.
    // The only time the WebPoker server sends data just
    // to this client is at the beginging, when the connection
    // is first made.  The first communication tells us which
    // connection number we are, which is very import.
    // So, we detect this situation where it is not game state

    // Take the msg and turn it into a javascript object
    const obj = JSON.parse(msg);
    if (!obj.players) {

      playerID = obj.Id;
      console.log("player ID = " + playerID);
      for (let i = 0; i < 5; i++) {
        cards[i] = obj.CardId[i];
      }
      document.getElementById("textbox").innerText =
      document.getElementById("textbox").innerText + '\n\n' + "Player ID is " + playerID;
      for (let i = 0; i < 5; i++) {
        document.getElementById(cardI[i]).src = cards[i].toString()+".svg";
        //console.log("attempted " + cardI[i] + " " + cards[i].toString()+".svg");
      }
    }
    if (obj.round_num == 1)
    {
      document.getElementById("roundDisplay").innerText = "\n\nCurrent Round:\nBetting Round #1";
    }
    else if (obj.round_num == 2)
    {
      document.getElementById("roundDisplay").innerText = "\n\nCurrent Round:\nDraw Round";
    }
    else if (obj.round_num == 4)
    {
      document.getElementById("roundDisplay").innerText = "\n\nCurrent Round:\nShowdown Round";
    }
    else
    {
      document.getElementById("roundDisplay").innerText = "\n\nCurrent Round:\nBetting Round #2";
    }
    //else {
      // process the game state
      // this will just have one card change every time a new game state comes in.
      // the term LUT means "look up table".  you will see it sometimes in code written last 
      // century.
      /*
      cardLUT = ["3C.svg", "2B.svg", "3S.svg", "KC.svg", "6D.svg", "2J.svg", "2S.svg"];
      
      document.getElementById("card4").src = cardLUT[cardIdx];
      cardIdx = cardIdx + 1;
      if (cardIdx > 6) {
        cardIdx = 0;
      }
      */
    //}
    //console.log("the cardIdx is " + cardIdx)
  }

  //document.getElementById("credentials").innerHTML='ID:'+playerID+'\n'+name;

  function rangeSlide(value) {
    document.getElementById("rangeValue").innerHTML = value;
  }

  function send() {

    var msg = {
      text: document.getElementById("send_text").value,
      playerID: playerID,
      name: name
    };
    connection.send(JSON.stringify(msg));
    console.log(JSON.stringify(msg));
  }
  function sendName() {

    var msg = {
      event: "NAME",
      name: document.getElementById("sendName").value,
      playerID: playerID,
    };
    name = document.getElementById("sendName").value;
    connection.send(JSON.stringify(msg));
    console.log(JSON.stringify(msg));
    document.getElementById("credentials").innerHTML='ID:'+playerID+'\n'+name;

    // this shows how to hid html elements.
    // like when the name is entered
    //  it might be better to hide after the server has accepted it
    // but this is just a demonstration

    var x = document.getElementById("nameInput");
    if (x.style.display === "none") {
      x.style.display = "block";
    } else {
      x.style.display = "none";
    }

  }

  // when stand is chosen, prompt the user to click and choose on which cards to discard, if none, just click confirm
  function stand(cond) {
    if (cond == 0) {
      document.getElementById("standPrompt").classList.remove("hidden");
      document.getElementById("bet").classList.add("hidden");
      document.getElementById("fold").classList.add("hidden");
    }
    else if (cond == -1) {
      document.getElementById("standPrompt").classList.add("hidden");
      document.getElementById("bet").classList.remove("hidden");
      document.getElementById("fold").classList.remove("hidden");
    } else {
        var msg = {
        event: "STAND",
        playerID: playerID,
        name: name
      };
      connection.send(JSON.stringify(msg));
      console.log(msg);
      document.getElementById("stand").classList.add("hidden");
      document.getElementById("standPrompt").classList.add("hidden");
      document.getElementById("bet").classList.add("hidden");
      document.getElementById("fold").classList.add("hidden");
    }
    return;
  }

  function bet(cond) {
    if (cond > 0) {
      var msg = {
        event: "BET",
        amount: cond,
        playerID: playerID,
        name: name
      };
      connection.send(JSON.stringify(msg));
      console.log(msg);
      document.getElementById("slide").classList.add("hidden");
      document.getElementById("slide").classList.add("hidden");
      document.getElementById("stand").classList.remove("hidden");
      document.getElementById("fold").classList.remove("hidden");
      return;
    }
    else if (cond == 0) {
      document.getElementById("slide").classList.remove("hidden");
      document.getElementById("slide").classList.add("slidercontainer");
      document.getElementById("stand").classList.add("hidden");
      document.getElementById("fold").classList.add("hidden");
      return;
    }
    else if (cond == -1) {
      document.getElementById("slide").classList.add("hidden");
      document.getElementById("stand").classList.remove("hidden");
      document.getElementById("fold").classList.remove("hidden");
      return;
    }
    
    //connection.send(JSON.stringify({BET}));
    console.log("Bet");
  }

  function fold(cond) {
    if (cond == 0) {
      document.getElementById("foldPrompt").classList.remove("hidden");
      document.getElementById("stand").classList.add("hidden");
      document.getElementById("bet").classList.add("hidden");
    }
    else if (cond == -1) {
      document.getElementById("foldPrompt").classList.add("hidden");
      document.getElementById("stand").classList.remove("hidden");
      document.getElementById("bet").classList.remove("hidden");
    }
    else {
      var msg = {
        event: "FOLD",
        playerID: playerID,
        name: name
      };
      connection.send(JSON.stringify(msg));
      console.log(msg);
      document.getElementById("fold").classList.add("hidden");
      document.getElementById("foldPrompt").classList.add("hidden");
      document.getElementById("stand").classList.add("hidden");
      document.getElementById("bet").classList.add("hidden");
    }
    return;
  }

  function cancel() {
    document.getElementById("slide").classList.add("hidden");
  }

</script>
